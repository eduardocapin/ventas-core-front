<div class="background-light-gray screen importador-documentos">
  <!-- Barra superior sticky con controles -->
  <div class="sticky-top-bar">
    <div class="p-3">
      <div class="d-flex justify-content-between align-items-center gap-3">
        <!-- Selector de empresa con etiqueta -->
        <div class="d-flex align-items-center gap-2 flex-grow-1">
          <label class="mb-0 text-muted small fw-semibold sticky-control-label">
            {{ 'importadorDocumentos.empresa' | translate }}:
          </label>
          <mobentis-empresa-dropdown 
            [forceShow]="true"
            (empresasChange)="onEmpresasChange($event)">
          </mobentis-empresa-dropdown>
        </div>
        
        <!-- Botón para colapsar/expandir KPIs -->
        <button 
          class="btn btn-sm btn-outline-secondary sticky-control-btn"
          (click)="toggleKpisColapsados()"
          [title]="(kpisColapsados ? 'importadorDocumentos.kpi.expand' : 'importadorDocumentos.kpi.collapse') | translate">
          <i class="bi bi-bar-chart-fill me-1"></i>
          <i class="bi" [class.bi-chevron-down]="!kpisColapsados" [class.bi-chevron-up]="kpisColapsados"></i>
          <span class="ms-1 d-none d-sm-inline">{{ (kpisColapsados ? 'importadorDocumentos.kpi.expand' : 'importadorDocumentos.kpi.collapse') | translate }}</span>
        </button>
      </div>
    </div>
  </div>

  <div class="p-3">
    <mobentis-page-title [title]="'importadorDocumentos.title' | translate" icon="file-earmark-arrow-up" [isBootstrapIcon]="true"></mobentis-page-title>
    
    <!-- KPIs del Header -->
    <div class="header-kpis mt-4 mb-4">
      <!-- Título de KPIs -->
      <div class="kpis-header-controls d-flex justify-content-between align-items-center" 
           [class.kpis-header-collapsed]="kpisColapsados">
        <h6 class="mb-0 text-muted small fw-semibold">
          <i class="bi bi-bar-chart-fill me-1"></i>
          {{ 'importadorDocumentos.kpi.title' | translate }}
        </h6>
      </div>
      
      <div *ngIf="loadingKpis" class="kpis-loading">
        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
        <span class="ms-2 small text-muted">{{ 'importadorDocumentos.loading' | translate }}</span>
      </div>
      <div *ngIf="!loadingKpis" class="kpis-content" [class.kpis-collapsed]="kpisColapsados">
        <div class="kpis-grid">
        <div class="kpi-card kpi-card-total" 
             [class.kpi-card-active]="isEstadoFiltrado(null)"
             (click)="onKpiClick(null)"
             [title]="'importadorDocumentos.kpi.clickToFilter' | translate">
          <div class="kpi-card-inner">
            <div class="kpi-header">
              <div class="kpi-icon-wrapper">
                <div class="kpi-icon kpi-total">
                  <i class="bi bi-file-earmark-text"></i>
                </div>
              </div>
              <div class="kpi-label">{{ 'importadorDocumentos.kpi.totalDocumentos' | translate }}</div>
            </div>
            <div class="kpi-value-wrapper">
              <div class="kpi-value" [class.kpi-value-zero]="getKpiTotalDocumentos() === 0">{{ getKpiTotalDocumentos() | number }}</div>
            </div>
          </div>
          <div class="kpi-accent kpi-accent-total" [class.kpi-accent-active]="isEstadoFiltrado(null)"></div>
        </div>
        
        <div class="kpi-card kpi-card-pending" 
             [class.kpi-card-active]="isEstadoFiltrado('sin_integrar')"
             (click)="onKpiClick('sin_integrar')"
             [title]="'importadorDocumentos.kpi.clickToFilter' | translate">
          <div class="kpi-card-inner">
            <div class="kpi-header">
              <div class="kpi-icon-wrapper">
                <div class="kpi-icon kpi-pending">
                  <i class="bi bi-circle"></i>
                </div>
              </div>
              <div class="kpi-label">{{ 'importadorDocumentos.kpi.pendientes' | translate }}</div>
            </div>
            <div class="kpi-value-wrapper">
              <div class="kpi-value" [class.kpi-value-zero]="getKpiPendientes() === 0">{{ getKpiPendientes() | number }}</div>
            </div>
          </div>
          <div class="kpi-accent kpi-accent-pending" [class.kpi-accent-active]="isEstadoFiltrado('sin_integrar')"></div>
        </div>
        
        <div class="kpi-card kpi-card-success" 
             [class.kpi-card-active]="isEstadoFiltrado('integrado')"
             (click)="onKpiClick('integrado')"
             [title]="'importadorDocumentos.kpi.clickToFilter' | translate">
          <div class="kpi-card-inner">
            <div class="kpi-header">
              <div class="kpi-icon-wrapper">
                <div class="kpi-icon kpi-success">
                  <i class="bi bi-check-circle-fill"></i>
                </div>
              </div>
              <div class="kpi-label">{{ 'importadorDocumentos.kpi.integrados' | translate }}</div>
            </div>
            <div class="kpi-value-wrapper">
              <div class="kpi-value" [class.kpi-value-zero]="getKpiIntegrados() === 0">{{ getKpiIntegrados() | number }}</div>
            </div>
          </div>
          <div class="kpi-accent kpi-accent-success" [class.kpi-accent-active]="isEstadoFiltrado('integrado')"></div>
        </div>
        
        <div class="kpi-card kpi-card-warning" 
             [class.kpi-card-active]="isEstadoFiltrado('integrado_con_incidencia')"
             (click)="onKpiClick('integrado_con_incidencia')"
             [title]="'importadorDocumentos.kpi.clickToFilter' | translate">
          <div class="kpi-card-inner">
            <div class="kpi-header">
              <div class="kpi-icon-wrapper">
                <div class="kpi-icon kpi-warning">
                  <i class="bi bi-exclamation-triangle-fill"></i>
                </div>
              </div>
              <div class="kpi-label">{{ 'importadorDocumentos.kpi.integradosConIncidencia' | translate }}</div>
            </div>
            <div class="kpi-value-wrapper">
              <div class="kpi-value" [class.kpi-value-zero]="getKpiIntegradosConIncidencia() === 0">{{ getKpiIntegradosConIncidencia() | number }}</div>
            </div>
          </div>
          <div class="kpi-accent kpi-accent-warning" [class.kpi-accent-active]="isEstadoFiltrado('integrado_con_incidencia')"></div>
        </div>
        
        <div class="kpi-card kpi-card-error" 
             [class.kpi-card-active]="isEstadoFiltrado('no_integrado_por_incidencia')"
             (click)="onKpiClick('no_integrado_por_incidencia')"
             [title]="'importadorDocumentos.kpi.clickToFilter' | translate">
          <div class="kpi-card-inner">
            <div class="kpi-header">
              <div class="kpi-icon-wrapper">
                <div class="kpi-icon kpi-error">
                  <i class="bi bi-x-circle-fill"></i>
                </div>
              </div>
              <div class="kpi-label">{{ 'importadorDocumentos.kpi.noIntegradosPorIncidencia' | translate }}</div>
            </div>
            <div class="kpi-value-wrapper">
              <div class="kpi-value" [class.kpi-value-zero]="getKpiNoIntegradosPorIncidencia() === 0">{{ getKpiNoIntegradosPorIncidencia() | number }}</div>
            </div>
          </div>
          <div class="kpi-accent kpi-accent-error" [class.kpi-accent-active]="isEstadoFiltrado('no_integrado_por_incidencia')"></div>
        </div>
        
        <div class="kpi-card kpi-card-processing" 
             [class.kpi-card-active]="isEstadoFiltrado('integrandose')"
             (click)="onKpiClick('integrandose')"
             [title]="'importadorDocumentos.kpi.clickToFilter' | translate">
          <div class="kpi-card-inner">
            <div class="kpi-header">
              <div class="kpi-icon-wrapper">
                <div class="kpi-icon kpi-processing">
                  <i class="bi bi-arrow-repeat"></i>
                </div>
              </div>
              <div class="kpi-label">{{ 'importadorDocumentos.kpi.enProceso' | translate }}</div>
            </div>
            <div class="kpi-value-wrapper">
              <div class="kpi-value" [class.kpi-value-zero]="getKpiEnProceso() === 0">{{ getKpiEnProceso() | number }}</div>
            </div>
          </div>
          <div class="kpi-accent kpi-accent-processing" [class.kpi-accent-active]="isEstadoFiltrado('integrandose')"></div>
        </div>
        </div>
        
        <!-- Indicador de filtro activo -->
        <div *ngIf="estadoFiltroActivo !== null" class="kpi-filter-indicator mt-2">
        <div class="d-flex align-items-center gap-2">
          <span class="small text-muted">
            <i class="bi bi-funnel-fill me-1"></i>
            {{ 'importadorDocumentos.kpi.filterActive' | translate }}: 
            <strong>{{ getEstadoLabel(estadoFiltroActivo) }}</strong>
          </span>
          <button class="btn btn-sm btn-outline-secondary" (click)="limpiarFiltroEstado()">
            <i class="bi bi-x-circle me-1"></i>
            {{ 'importadorDocumentos.kpi.clearFilter' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="p-3 d-flex flex-column gap-0">
    <!-- Barra de acciones (Core: mobentis-search-input) -->
    <div class="d-flex align-items-center justify-content-between gap-3 mb-2">
      <div class="d-flex align-items-center gap-2">
        <mobentis-search-input
          [searchTerm]="searchTerm"
          (searchChange)="onSearch($event)">
        </mobentis-search-input>
        <button class="btn btn-outline-secondary btn-sm" (click)="onFiltros()">
          <i class="bi bi-funnel me-1"></i>
          {{ 'importadorDocumentos.filters' | translate }}
        </button>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button
          class="btn btn-primary btn-sm"
          [disabled]="pedidosInt.size === 0"
          (click)="onIntegrar()">
          <i class="bi bi-upload me-1"></i>
          {{ 'importadorDocumentos.integrate' | translate }}
        </button>
        <button
          class="btn btn-outline-primary btn-sm"
          [disabled]="!pedidoSeleccionado"
          (click)="onAbrir()">
          <i class="bi bi-box-arrow-up-right me-1"></i>
          {{ 'importadorDocumentos.open' | translate }}
        </button>
      </div>
    </div>

    <!-- Error al cargar pedidos -->
    <div *ngIf="loadError" class="alert alert-danger mb-3" role="alert">
      <i class="bi bi-exclamation-triangle me-2"></i>
      {{ loadError }}
      <button type="button" class="btn btn-sm btn-outline-danger ms-2" (click)="loadPedidos()">
        <i class="bi bi-arrow-clockwise me-1"></i>{{ 'importadorDocumentos.retry' | translate }}
      </button>
    </div>

    <!-- Tabla de pedidos (Core: mobentis-table). Doble clic en una fila carga el detalle en el panel inferior. -->
    <div class="documents-grid" [class.d-none]="loading" (dblclick)="onTableRowDblClick($event)">
      <mobentis-table
        [data]="pedidosParaTabla"
        [columns]="tableColumns"
        [selectedIds]="selectedIds"
        [getId]="getId.bind(this)"
        [sortColumn]="sortColumn"
        [sortDirection]="sortDirection"
        (selectionChange)="onSelectionChange($event)"
        (sortChange)="onSortChange($event)"
        (action)="onTableAction($event)">
      </mobentis-table>
    </div>
    <div *ngIf="loading" class="text-center py-4">
      <div class="spinner-border text-primary" role="status"></div>
    </div>

    <!-- Paginación (Core: mobentis-pagination) -->
    <mobentis-pagination
      *ngIf="totalItems > 0"
      [totalItems]="totalItems"
      [itemsPerPage]="itemsPerPage"
      [currentPage]="currentPage"
      [entityName]="'importadorDocumentos.pedidos' | translate"
      (pageChange)="onPageChange($event)"
      (itemsPerPageChanged)="onItemsPerPageChange($event)">
    </mobentis-pagination>

    <!-- Leyenda de integración -->
    <div class="leyenda-integracion">
      <span class="leyenda-item">
        <i class="bi bi-circle estado-pending"></i>
        {{ 'importadorDocumentos.legend.pending' | translate }}
      </span>
      <span class="leyenda-item">
        <i class="bi bi-check-circle-fill estado-success"></i>
        {{ 'importadorDocumentos.legend.success' | translate }}
      </span>
      <span class="leyenda-item">
        <i class="bi bi-x-circle-fill estado-error"></i>
        {{ 'importadorDocumentos.legend.error' | translate }}
      </span>
      <span class="leyenda-item">
        <i class="bi bi-exclamation-triangle-fill estado-warning"></i>
        {{ 'importadorDocumentos.legend.warning' | translate }}
      </span>
      <span class="leyenda-item">
        <i class="bi bi-arrow-repeat estado-processing"></i>
        {{ 'importadorDocumentos.legend.inProgress' | translate }}
      </span>
      <span class="leyenda-item">
        <i class="bi bi-clock-fill estado-cian"></i>
        {{ 'importadorDocumentos.legend.pendingServe' | translate }}
      </span>
    </div>

    <!-- Panel de detalle (Core: mobentis-popup-header + mobentis-table para líneas) -->
    <div class="panel-detalle" *ngIf="pedidoSeleccionado">
      <mobentis-popup-header
        [title]="getDetalleHeaderTitle()"
        icon="file-text"
        [isBootstrapIcon]="true"
        (close)="cerrarDetalle()">
      </mobentis-popup-header>
      <div class="panel-detalle-body">
        <div *ngIf="loadingDetalle" class="text-center py-3">
          <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
        </div>
        <div class="tabla-lineas" *ngIf="!loadingDetalle && lineasParaTabla.length">
          <mobentis-table
            [data]="lineasParaTabla"
            [columns]="detalleTableColumns"
            [sortColumn]="''"
            [sortDirection]="'asc'">
          </mobentis-table>
        </div>
        <p *ngIf="!loadingDetalle && detalleSeleccionado && !lineasParaTabla.length" class="small text-muted mb-0">
          {{ 'importadorDocumentos.detail.noLineas' | translate }}
        </p>
        <div class="observaciones mt-3" *ngIf="!loadingDetalle && detalleSeleccionado">
          <div class="mb-3">
            <label class="form-label small fw-semibold">{{ 'importadorDocumentos.detail.notas' | translate }}</label>
            <p class="small mb-0">{{ detalleSeleccionado.observacionesComerciales || '−' }}</p>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-semibold">{{ 'importadorDocumentos.detail.notasLogisticas' | translate }}</label>
            <p class="small mb-0">{{ detalleSeleccionado.observacionesReparto || '−' }}</p>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="!pedidoSeleccionado" class="panel-detalle-empty">
      <i class="bi bi-hand-index text-muted"></i>
      <p class="text-muted mb-0 mt-2">{{ 'importadorDocumentos.selectDocument' | translate }}</p>
    </div>
  </div>
</div>
