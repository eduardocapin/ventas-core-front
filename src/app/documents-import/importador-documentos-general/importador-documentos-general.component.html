<div class="background-light-gray screen importador-documentos">
  <div class="p-3">
    <mobentis-page-title [title]="'importadorDocumentos.title' | translate" icon="file-earmark-arrow-up" [isBootstrapIcon]="true"></mobentis-page-title>
  </div>

  <div class="p-3 d-flex flex-column gap-0">
    <!-- KPIs por estado de pedidos (Core: mobentis-etiqueta-valor-vertical para KPIs dinámicos, ver Core_Components_Catalog) -->
    <div class="mb-3">
      <p class="small fw-semibold text-muted mb-2">{{ 'importadorDocumentos.kpisEstados' | translate }}</p>
      <div *ngIf="loadingKpis" class="d-flex align-items-center gap-2">
        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
        <span class="small">{{ 'importadorDocumentos.loading' | translate }}</span>
      </div>
      <div *ngIf="!loadingKpis && kpisEstadosOrdenados.length" class="d-flex flex-wrap gap-3 align-items-start">
        <mobentis-etiqueta-valor-vertical
          *ngFor="let kpi of kpisEstadosOrdenados"
          [etiqueta]="kpi.label"
          [valor]="kpi.value"
          [colorEtiqueta]="'#3f51b5'">
        </mobentis-etiqueta-valor-vertical>
      </div>
      <p *ngIf="!loadingKpis && !kpisEstadosOrdenados.length" class="small text-muted mb-0">{{ 'importadorDocumentos.noKpis' | translate }}</p>
    </div>

    <!-- Barra de acciones (Core: mobentis-search-input) -->
    <div class="d-flex align-items-center justify-content-between gap-3 mb-2">
      <div class="d-flex align-items-center gap-2">
        <mobentis-search-input
          [searchTerm]="searchTerm"
          (searchChange)="onSearch($event)">
        </mobentis-search-input>
        <button class="btn btn-outline-secondary btn-sm" (click)="onFiltros()">
          <i class="bi bi-funnel me-1"></i>
          {{ 'importadorDocumentos.filters' | translate }}
        </button>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button
          class="btn btn-primary btn-sm"
          [disabled]="pedidosInt.size === 0"
          (click)="onIntegrar()">
          <i class="bi bi-upload me-1"></i>
          {{ 'importadorDocumentos.integrate' | translate }}
        </button>
        <button
          class="btn btn-outline-primary btn-sm"
          [disabled]="!pedidoSeleccionado"
          (click)="onAbrir()">
          <i class="bi bi-box-arrow-up-right me-1"></i>
          {{ 'importadorDocumentos.open' | translate }}
        </button>
      </div>
    </div>

    <!-- Error al cargar pedidos -->
    <div *ngIf="loadError" class="alert alert-danger mb-3" role="alert">
      <i class="bi bi-exclamation-triangle me-2"></i>
      {{ loadError }}
      <button type="button" class="btn btn-sm btn-outline-danger ms-2" (click)="loadPedidos()">
        <i class="bi bi-arrow-clockwise me-1"></i>{{ 'importadorDocumentos.retry' | translate }}
      </button>
    </div>

    <!-- Tabla de pedidos (Core: mobentis-table). Doble clic en una fila carga el detalle en el panel inferior. -->
    <div class="documents-grid" [class.d-none]="loading" (dblclick)="onTableRowDblClick($event)">
      <mobentis-table
        [data]="pedidosParaTabla"
        [columns]="tableColumns"
        [selectedIds]="selectedIds"
        [getId]="getId.bind(this)"
        [sortColumn]="sortColumn"
        [sortDirection]="sortDirection"
        (selectionChange)="onSelectionChange($event)"
        (sortChange)="onSortChange($event)"
        (action)="onTableAction($event)">
      </mobentis-table>
    </div>
    <div *ngIf="loading" class="text-center py-4">
      <div class="spinner-border text-primary" role="status"></div>
    </div>

    <!-- Paginación (Core: mobentis-pagination) -->
    <mobentis-pagination
      *ngIf="totalItems > 0"
      [totalItems]="totalItems"
      [itemsPerPage]="itemsPerPage"
      [currentPage]="currentPage"
      [entityName]="'importadorDocumentos.pedidos' | translate"
      (pageChange)="onPageChange($event)"
      (itemsPerPageChanged)="onItemsPerPageChange($event)">
    </mobentis-pagination>

    <!-- Leyenda de integración -->
    <div class="leyenda-integracion">
      <span class="leyenda-item">
        <i class="bi bi-circle estado-blanco"></i>
        {{ 'importadorDocumentos.legend.pending' | translate }}
      </span>
      <span class="leyenda-item">
        <i class="bi bi-check-circle-fill estado-verde"></i>
        {{ 'importadorDocumentos.legend.success' | translate }}
      </span>
      <span class="leyenda-item">
        <i class="bi bi-x-circle-fill estado-rojo"></i>
        {{ 'importadorDocumentos.legend.error' | translate }}
      </span>
      <span class="leyenda-item">
        <i class="bi bi-exclamation-triangle-fill estado-amarillo"></i>
        {{ 'importadorDocumentos.legend.warning' | translate }}
      </span>
      <span class="leyenda-item">
        <i class="bi bi-arrow-repeat estado-azul"></i>
        {{ 'importadorDocumentos.legend.inProgress' | translate }}
      </span>
      <span class="leyenda-item">
        <i class="bi bi-clock-fill estado-cian"></i>
        {{ 'importadorDocumentos.legend.pendingServe' | translate }}
      </span>
    </div>

    <!-- Panel de detalle (Core: mobentis-popup-header + mobentis-table para líneas) -->
    <div class="panel-detalle" *ngIf="pedidoSeleccionado">
      <mobentis-popup-header
        [title]="getDetalleHeaderTitle()"
        icon="file-text"
        [isBootstrapIcon]="true"
        (close)="cerrarDetalle()">
      </mobentis-popup-header>
      <div class="panel-detalle-body">
        <div *ngIf="loadingDetalle" class="text-center py-3">
          <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
        </div>
        <div class="tabla-lineas" *ngIf="!loadingDetalle && lineasParaTabla.length">
          <mobentis-table
            [data]="lineasParaTabla"
            [columns]="detalleTableColumns"
            [sortColumn]="''"
            [sortDirection]="'asc'">
          </mobentis-table>
        </div>
        <p *ngIf="!loadingDetalle && detalleSeleccionado && !lineasParaTabla.length" class="small text-muted mb-0">
          {{ 'importadorDocumentos.detail.noLineas' | translate }}
        </p>
        <div class="observaciones mt-3" *ngIf="!loadingDetalle && detalleSeleccionado">
          <label class="form-label small fw-semibold">{{ 'importadorDocumentos.detail.notas' | translate }}</label>
          <p class="small mb-0">{{ detalleSeleccionado.observaciones || '−' }}</p>
        </div>
      </div>
    </div>

    <div *ngIf="!pedidoSeleccionado" class="panel-detalle-empty">
      <i class="bi bi-hand-index text-muted"></i>
      <p class="text-muted mb-0 mt-2">{{ 'importadorDocumentos.selectDocument' | translate }}</p>
    </div>
  </div>
</div>
